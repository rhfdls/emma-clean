# 0009: EF Model Sync (RowVersion and FK cleanup)

- Status: Proposed
- Date: 2025-09-15

## Context

During CI hardening, an ef-model-vs-migrations guard detected model drift between the CLR model and the EF migration snapshot. The initial scaffolded migration attempted broad changes (e.g., making many `RowVersion` columns nullable, introducing a shadow FK `ContactId1` on `EmailAddresses`, and dropping `Contacts.DeletedById`). These were not intended schema changes.

Per ADR 0007 (Schema Change Policy), all schema changes must be documented and safe. We reconciled mappings to avoid unintended, risky changes and produced a minimal, intentional migration.

## Decision

- Keep `RowVersion` as a non-nullable, DB-managed concurrency token.
  - `src/Emma.Models/Models/BaseEntity.cs`: `RowVersion` is non-nullable `byte[]` with `[Timestamp]`.
  - `src/Emma.Infrastructure/Data/EmmaDbContext.cs`: use `.IsRowVersion()` for Contact mapping (and consistent usage elsewhere as needed).
- Fix FK mapping to avoid shadow property `ContactId1` on `EmailAddresses`.
  - Ensure relationship uses `EmailAddress.ContactId` and is not double-mapped or ignored elsewhere.
- Do not drop `Contacts.DeletedById`. Map `BaseEntity.DeletedById` to legacy column name `DeletedByUserId` to preserve schema continuity.
- Do not accept broad nullability changes or shadow FKs. The migration should be minimal and safe.

## Consequences

- Concurrency semantics remain strong (non-nullable `RowVersion`).
- The EF model snapshot matches the CLR model; CI model-drift guard passes.
- No destructive schema changes; audit fields such as `DeletedById` remain intact.

## Migration

A minimal synchronization migration was created after fixing mappings so that no unintended mass changes are applied. The migration and target schema were regenerated via:

- `dotnet ef migrations add sync_model_20250915b --project src/Emma.Infrastructure/Emma.Infrastructure.csproj --startup-project src/Emma.Api/Emma.Api.csproj --context Emma.Infrastructure.Data.EmmaDbContext`
- `dotnet ef migrations script 0 --idempotent --output artifacts/ef_target_schema.sql`

## Rollback Plan

If issues are discovered, remove the migration and revert mapping changes. Since the migration is minimal and non-destructive, rollback risks are low.

## References

- ADR 0007: Schema Change Policy
- Files:
  - `src/Emma.Models/Models/BaseEntity.cs`
  - `src/Emma.Infrastructure/Data/EmmaDbContext.cs`
  - `src/Emma.Infrastructure/Migrations/` (migration files)
