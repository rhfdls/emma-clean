using Microsoft.EntityFrameworkCore;
using DotNetEnv;

try
{
    Console.WriteLine("ğŸš€ Starting MINIMAL Emma AI Platform...");
    
    // Load environment variables from .env
    Console.WriteLine("ğŸ“ Loading environment variables from .env file...");
    Env.Load("../.env");
    Console.WriteLine("âœ… Environment variables loaded successfully");

    Console.WriteLine("ğŸ—ï¸ Creating minimal web application builder...");
    var builder = WebApplication.CreateBuilder(args);
    
    // Explicitly configure URLs
    builder.WebHost.UseUrls("http://localhost:5262");
    Console.WriteLine("âœ… Web application builder created with URL: http://localhost:5262");

    // Add only essential services
    builder.Services.AddControllers();
    builder.Services.AddEndpointsApiExplorer();
    builder.Services.AddSwaggerGen();

    Console.WriteLine("ğŸ¯ Building minimal application...");
    var app = builder.Build();
    Console.WriteLine("âœ… Minimal application built successfully");

    // Configure the HTTP request pipeline
    if (app.Environment.IsDevelopment())
    {
        app.UseSwagger();
        app.UseSwaggerUI();
        Console.WriteLine("âœ… Swagger configured for development environment");
    }

    app.UseRouting();
    app.MapControllers();

    // Add a simple test endpoint
    app.MapGet("/test", () => "Emma AI Platform is running!");
    Console.WriteLine("âœ… Routes and endpoints configured");

    Console.WriteLine("ğŸŒ Starting minimal web application...");
    Console.WriteLine("ğŸ“ Application should be available at: http://localhost:5262");
    Console.WriteLine("ğŸ“ Swagger UI: http://localhost:5262/swagger");
    Console.WriteLine("ğŸ“ Test endpoint: http://localhost:5262/test");
    Console.WriteLine("â³ Starting server... (this should block and keep running)");
    
    app.Run();
}
catch (Exception ex)
{
    Console.WriteLine($"âŒ FATAL ERROR during startup: {ex.Message}");
    Console.WriteLine($"ğŸ“ Exception Type: {ex.GetType().Name}");
    Console.WriteLine($"ğŸ“ Stack Trace: {ex.StackTrace}");
    
    if (ex.InnerException != null)
    {
        Console.WriteLine($"ğŸ”— Inner Exception: {ex.InnerException.Message}");
        Console.WriteLine($"ğŸ“ Inner Stack Trace: {ex.InnerException.StackTrace}");
    }
    
    Console.WriteLine("\nâ¸ï¸ Press any key to exit...");
    Console.ReadKey();
    Environment.Exit(1);
}
